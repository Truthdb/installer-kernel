name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  KERNEL_VERSION: 6.12
  KERNEL_CONFIG: truthdb-installer-kernel.config
  KERNEL_TARBALL_SHA256: b1a2562be56e42afb3f8489d4c2a7ac472ac23098f1ef1c1e40da601f54625eb

jobs:
  release:
    uses: Truthdb/.github/.github/workflows/standard-release.yml@workflows-v1
    with:
      project_name: installer-kernel
      runs_on: ubuntu-24.04
      install_packages: |
        build-essential
        ca-certificates
        bc
        bison
        flex
        libncurses5-dev
        libssl-dev
        libelf-dev
        dwarves
        cpio
        xz-utils
        wget
        git
      assets_list: |
        - BOOTX64.EFI
      files: dist/BOOTX64.EFI
      build_script: |
        set -euo pipefail

        mkdir -p kernel-src
        cd kernel-src
        wget "https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${KERNEL_VERSION}.tar.xz"
        echo "${KERNEL_TARBALL_SHA256}  linux-${KERNEL_VERSION}.tar.xz" | sha256sum -c -
        tar xf "linux-${KERNEL_VERSION}.tar.xz" --strip-components=1

        cp "../${KERNEL_CONFIG}" .config
        test -s .config

        make -j"$(nproc)" bzImage

        cd ..
        mkdir -p dist
        cp kernel-src/arch/x86/boot/bzImage dist/BOOTX64.EFI
