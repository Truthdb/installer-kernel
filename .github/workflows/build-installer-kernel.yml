name: Build installer kernel 

on:
  push:
    tags:
      - '*.*.*'
      
jobs:
  build-linux-kernel:
    uses: ./.github/workflows/build-linux-kernel.yml
    with:
      make_release: true

  create-release:
    needs: build-linux-kernel
    runs-on: ubuntu-24.04

    permissions:
      contents: write

    steps:
      - name: Download built kernel artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: truthdb-installer-kernel-${{ github.sha }}
          path: dist

      - name: Create or update GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          test -f dist/BOOTX64.EFI

          generated_notes=$(gh api -X POST "repos/$REPO/releases/generate-notes" \
            -f tag_name="$TAG" \
            -f target_commitish="$GITHUB_SHA" \
            --jq .body)

          cat > release_body.md <<EOF
          ${generated_notes}

          ## Installer kernel

          - EFI kernel: BOOTX64.EFI
          EOF

          if gh release view "$TAG" --repo "$REPO" >/dev/null 2>&1; then
            gh release edit "$TAG" --repo "$REPO" --title "$TAG" --notes-file release_body.md
          else
            gh release create "$TAG" --repo "$REPO" --title "$TAG" --notes-file release_body.md
          fi

          gh release upload "$TAG" --repo "$REPO" dist/BOOTX64.EFI --clobber
    